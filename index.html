<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClubPro V14.1 - Financial Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; margin: 0; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-amber { background-color: #f59e0b; color: #000; font-weight: 900; }
        .arrived { border-right: 4px solid #22c55e !important; background: rgba(34, 197, 94, 0.05) !important; }
        .group-header { background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, transparent 100%); border-right: 4px solid #f59e0b; }
    </style>
</head>
<body>
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-xl hidden font-bold shadow-2xl bg-green-600 text-white text-right"></div>
    <div id="app"></div>
    <script>
        const config = {
            firebase: {
                apiKey: "AIzaSyD2y4clTGDYnZmmO8Gyg0bXqsyafF-a_GI",
                authDomain: "clubpro-system.firebaseapp.com",
                projectId: "clubpro-system",
                storageBucket: "clubpro-system.firebasestorage.app",
                messagingSenderId: "825897406218",
                appId: "1:825897406218:web:a660e48a120361247934f3"
            }
        };
        firebase.initializeApp(config.firebase);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let state = { user: null, role: null, userName: '', phone: '', reservations: [], isAdding: false, editingId: null, showAllFuture: false, showSummary: false, selectedDate: new Date().toISOString().split('T')[0], formData: { type: 'table', pax: 1, clientName: '', clientPhone: '', manualPrice: null, eventDate: new Date().toISOString().split('T')[0], notes: '' } };

        function updateState(newData) { state = { ...state, ...newData }; render(); }
        async function login(val) {
            if (val.trim().toLowerCase() === 'res') {
                updateState({ role: 'admin', userName: 'Admin', phone: 'ADMIN' });
                localStorage.setItem('club_role', 'admin');
            } else if (val.trim().length >= 10) {
                updateState({ role: 'promoter', userName: 'יחצן', phone: val.trim() });
            }
        }

        function sendSummaryEmail() {
            const recipient = "MORGAN.FIMA@GMAIL.COM";
            const date = state.selectedDate;
            let body = `דוח עמלות לתאריך: ${date}\n\n`;
            const summary = {};
            state.reservations.filter(r => r.eventDate === date && r.status === 'active').forEach(r => {
                const p = r.promoterName || 'Admin';
                if (!summary[p]) summary[p] = 0;
                summary[p] += Number(r.actualRevenue || 0);
            });
            Object.entries(summary).forEach(([name, z]) => {
                body += `${name}: Z ₪${z} | עמלה (10%): ₪${(z * 0.1).toFixed(0)}\n`;
            });
            window.location.href = `mailto:${recipient}?subject=Revenue Report ${date}&body=${encodeURIComponent(body)}`;
        }

        function render() {
            const root = document.getElementById('app');
            if (!state.role) {
                root.innerHTML = `<div class="h-screen flex items-center justify-center p-4 text-right"><div class="w-full max-w-md glass p-10 rounded-[2rem] text-center"><h2 class="text-3xl font-black mb-8 italic text-white uppercase tracking-widest text-center">Staff Login</h2><input id="login-input" type="text" placeholder="קוד / טלפון" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 mb-4 text-center text-white text-xl outline-none"><button onclick="login(document.getElementById('login-input').value)" class="w-full btn-amber py-4 rounded-xl font-black uppercase shadow-xl">Login</button></div></div>`;
                return;
            }
            if (state.showSummary) {
                root.innerHTML = renderSummaryPage();
            } else {
                root.innerHTML = renderMainPage();
            }
            lucide.createIcons();
        }

        function renderSummaryPage() {
            const dayList = state.reservations.filter(r => r.eventDate === state.selectedDate && r.status === 'active');
            const summary = {};
            dayList.forEach(r => {
                const p = r.promoterName || 'Admin';
                if (!summary[p]) summary[p] = { z: 0 };
                summary[p].z += Number(r.actualRevenue || 0);
            });
            const totalComm = Object.values(summary).reduce((acc, curr) => acc + (curr.z * 0.1), 0);
            return `<div class="p-4 text-right"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-black text-amber-500 uppercase italic">סיכום עמלות - ${state.selectedDate}</h2><button onclick="updateState({showSummary: false})" class="bg-red-800 text-white px-4 py-2 rounded-lg text-xs font-black uppercase">חזור לניהול</button></div><div class="glass rounded-xl overflow-hidden mb-6"><table class="w-full text-sm text-right"><thead class="bg-white/5 text-[10px] font-black uppercase text-slate-400"><tr><th class="p-4">יחצן</th><th class="p-4">Z סופי</th><th class="p-4 text-amber-500">עמלה 10%</th></tr></thead><tbody class="divide-y divide-white/5">${Object.entries(summary).map(([name, data]) => `<tr><td class="p-4 font-bold">${name}</td><td class="p-4 text-green-400 font-bold">₪${data.z}</td><td class="p-4 text-amber-500 font-black italic">₪${(data.z * 0.1).toFixed(0)}</td></tr>`).join('')}</tbody><tfoot class="bg-amber-500/10"><tr class="font-black text-white"><td colspan="2" class="p-4">סה"כ עמלות לתשלום:</td><td class="p-4 text-amber-500 text-lg italic">₪${totalComm.toFixed(0)}</td></tr></tfoot></table></div><button onclick="sendSummaryEmail()" class="w-full bg-blue-600 p-5 rounded-xl font-black flex items-center justify-center gap-2 text-white shadow-xl uppercase italic"><i data-lucide="mail"></i> שלח סיכום במייל</button></div>`;
        }

        function renderMainPage() {
            const stats = { pax: 0, z: 0 };
            state.reservations.filter(r => r.eventDate === state.selectedDate && r.status === 'active').forEach(r => { stats.pax += Number(r.pax || 0); stats.z += Number(r.actualRevenue || 0); });
            return `<div class="flex flex-col h-screen text-right"><header class="p-4 bg-slate-950 flex justify-between items-center border-b border-white/5"><div>CLUB<span class="text-amber-500 font-black italic">PRO</span></div><button onclick="localStorage.clear(); location.reload();" class="text-slate-500"><i data-lucide="log-out"></i></button></header><div class="p-4 flex-1 overflow-y-auto"><div class="flex justify-between gap-2 mb-4"><button onclick="updateState({showSummary: true})" class="flex-1 bg-blue-600 text-white p-3 rounded-lg text-xs font-black uppercase shadow-lg">צפה בסיכום יחצנים</button><button onclick="updateState({isAdding: true})" class="flex-1 btn-amber p-3 rounded-lg text-xs font-black uppercase shadow-lg">הזמנה חדשה</button></div><div class="grid grid-cols-2 gap-2 mb-6"><div class="glass p-3 rounded-xl text-center"><p class="text-[8px] text-slate-500 uppercase font-black">Total Pax</p><p class="text-xl font-black">${stats.pax}</p></div><div class="glass p-3 rounded-xl text-center border-green-500/30 border"><p class="text-[8px] text-green-500 uppercase font-black">Total Z</p><p class="text-xl font-black text-green-400">₪${stats.z}</p></div></div><div class="space-y-4 text-right">${state.reservations.filter(r => r.eventDate === state.selectedDate && r.status === 'active').map(r => `<div class="glass p-3 rounded-xl flex justify-between items-center ${r.arrived ? 'arrived' : ''} text-right"><div><p class="font-bold text-white text-right text-xs">${r.name} (${r.pax})</p><p class="text-[9px] text-slate-500 text-right">Z: ₪${r.actualRevenue || 0}</p></div><div class="flex gap-2 items-center"><input type="number" placeholder="Z" value="${r.actualRevenue || ''}" onchange="db.collection('reservations').doc('${r.id}').update({actualRevenue: Number(this.value)})" class="w-12 bg-black border border-white/10 rounded p-1 text-center text-green-400 text-xs outline-none"></div></div>`).join('')}</div></div></div>`;
        }

        auth.onAuthStateChanged(user => {
            if (!user) { auth.signInAnonymously(); return; }
            db.collection('reservations').onSnapshot(snap => { updateState({ reservations: snap.docs.map(d => ({ id: d.id, ...d.data() })) }); });
            if (localStorage.getItem('club_role') === 'admin') updateState({ role: 'admin' });
        });
    </script>
</body>
</html>