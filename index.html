<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClubPro V14 - Elite Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; margin: 0; text-align: right; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-amber { background-color: #f59e0b; color: #000; font-weight: 900; }
        .arrived { border-right: 4px solid #22c55e !important; background: rgba(34, 197, 94, 0.05) !important; }
        .section-divider { background: linear-gradient(90deg, #f59e0b 0%, transparent 100%); padding: 6px 15px; margin-top: 20px; font-weight: 900; font-size: 13px; color: #000; border-radius: 4px; display: block; width: 100%; }
    </style>
</head>
<body>
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-xl hidden font-bold shadow-2xl bg-green-600 text-white"></div>
    <div id="app"></div>
    <script>
        const config = {
            firebase: {
                apiKey: "AIzaSyD2y4clTGDYnZmmO8Gyg0bXqsyafF-a_GI",
                authDomain: "clubpro-system.firebaseapp.com",
                projectId: "clubpro-system",
                storageBucket: "clubpro-system.firebasestorage.app",
                messagingSenderId: "825897406218",
                appId: "1:825897406218:web:a660e48a120361247934f3"
            }
        };
        const todayStr = new Date().toISOString().split('T')[0];
        firebase.initializeApp(config.firebase);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let state = {
            user: null, role: null, userName: '', phone: '', reservations: [],
            isAdding: false, editingId: null, showAllFuture: false,
            selectedDate: todayStr,
            formData: { type: 'table', pax: 1, clientName: '', clientPhone: '', manualPrice: null, eventDate: todayStr, notes: '' }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        async function login(val) {
            const clean = val.trim();
            if (clean === 'Res') {
                updateState({ role: 'admin', userName: 'Admin', phone: 'ADMIN' });
                localStorage.setItem('club_role', 'admin'); localStorage.setItem('club_name', 'Admin'); localStorage.setItem('club_phone', 'ADMIN');
            } else if (clean.length >= 10) {
                const userDoc = await db.collection('users').doc(clean).get();
                if (userDoc.exists) {
                    const d = userDoc.data();
                    updateState({ role: 'promoter', userName: d.name, phone: clean });
                } else {
                    const name = prompt("שם מלא לרישום:");
                    if (name) {
                        await db.collection('users').doc(clean).set({ name, phone: clean });
                        updateState({ role: 'promoter', userName: name, phone: clean });
                    }
                }
            }
        }

        function logout() { localStorage.clear(); location.reload(); }

        async function saveBooking(e) {
            e.preventDefault();
            let min = state.formData.manualPrice || (state.formData.type === 'free' ? 0 : Number(state.formData.pax) * 300);
            const data = {
                name: state.formData.clientName, phone: state.formData.clientPhone,
                type: state.formData.type, pax: Number(state.formData.pax),
                eventDate: state.formData.eventDate, minOrder: Number(min),
                notes: state.formData.notes || "", arrived: false,
                promoterId: state.phone, promoterName: state.userName,
                actualRevenue: 0, status: 'active', updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('reservations').add(data);
            updateState({ isAdding: false, formData: { ...state.formData, clientName: '', clientPhone: '', notes: '' } });
            showToast("נשמר!");
        }

        function updateState(newData) { state = { ...state, ...newData }; render(); }

        function render() {
            const root = document.getElementById('app');
            if (!state.role) { root.innerHTML = renderLogin(); return; }
            root.innerHTML = `
                <div class="flex flex-col h-screen overflow-hidden">
                    <header class="bg-slate-950 p-4 border-b border-white/5 flex justify-between items-center">
                        <div class="font-black italic text-xl uppercase">Club<span class="text-amber-500">Pro</span></div>
                        <button onclick="logout()" class="text-slate-500"><i data-lucide="log-out" size="18"></i></button>
                    </header>
                    <main class="flex-1 overflow-y-auto p-4">
                        ${state.role === 'promoter' ? renderPromoter() : renderAdmin()}
                    </main>
                </div>
            `;
            lucide.createIcons();
        }

        function renderLogin() {
            return `<div class="h-screen flex items-center justify-center p-4"><div class="w-full max-w-md glass p-10 rounded-[2rem] text-center border border-white/10"><h2 class="text-3xl font-black mb-8 italic uppercase text-white">Staff Login</h2><input id="login-input" type="text" placeholder="קוד / טלפון" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 mb-4 text-center text-white text-xl outline-none"><button onclick="login(document.getElementById('login-input').value)" class="w-full btn-amber py-4 rounded-xl">LOGIN</button></div></div>`;
        }

        function renderAdmin() {
            let list = state.reservations.filter(r => r.status === 'active' && r.eventDate === state.selectedDate);
            const stats = { pax: 0, tPax: 0, bPax: 0, z: 0 };
            list.forEach(r => {
                stats.pax += Number(r.pax || 0);
                if(r.type === 'table') stats.tPax += Number(r.pax || 0);
                if(r.type === 'bar') stats.bPax += Number(r.pax || 0);
                stats.z += Number(r.actualRevenue || 0);
            });

            const renderSection = (title, type) => {
                const group = list.filter(r => r.type === type);
                if (group.length === 0) return '';
                return `<div class="section-divider uppercase">${title}</div>` + group.map(res => `
                    <div class="glass p-3 mt-2 rounded-xl flex items-center justify-between ${res.arrived ? 'arrived' : ''}">
                        <div class="flex items-center gap-3 text-right">
                            <input type="checkbox" ${res.arrived?'checked':''} onchange="db.collection('reservations').doc('${res.id}').update({arrived: this.checked})" class="w-5 h-5 accent-green-500">
                            <div><p class="font-bold text-white text-sm">${res.name} (${res.pax})</p><p class="text-[10px] text-slate-400">${res.promoterName} | ${res.notes || 'אין הערות'}</p></div>
                        </div>
                    </div>
                `).join('');
            };

            return `
                <div class="max-w-6xl mx-auto space-y-4">
                    <div class="flex justify-between items-center"><h2 class="text-xl font-black italic">ADMIN PANEL</h2><button onclick="updateState({isAdding: true})" class="btn-amber px-6 py-2 rounded-lg text-sm">+ הזמנה חדשה</button></div>
                    ${state.isAdding ? renderBookingForm() : `
                        <div class="grid grid-cols-2 gap-2 text-center">
                            <div class="glass p-3 rounded-xl border border-blue-500/20"><p class="text-[9px] text-slate-500 uppercase">מוזמנים שולחן</p><p class="text-2xl font-black text-blue-400">${stats.tPax}</p></div>
                            <div class="glass p-3 rounded-xl border border-purple-500/20"><p class="text-[9px] text-slate-500 uppercase">מוזמנים בר</p><p class="text-2xl font-black text-purple-400">${stats.bPax}</p></div>
                        </div>
                        <div class="mt-4">
                            ${renderSection('שולחנות', 'table')}
                            ${renderSection('בר', 'bar')}
                            ${renderSection('חינם', 'free')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderBookingForm() {
            return `
                <div class="glass p-6 rounded-2xl space-y-4 text-right">
                    <input id="cName" placeholder="שם לקוח" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white outline-none">
                    <div class="flex gap-2">
                        <button onclick="state.formData.type='table'; render()" class="flex-1 p-2 rounded border ${state.formData.type==='table'?'bg-amber-500 text-black':'text-white'}">שולחן</button>
                        <button onclick="state.formData.type='bar'; render()" class="flex-1 p-2 rounded border ${state.formData.type==='bar'?'bg-amber-500 text-black':'text-white'}">בר</button>
                    </div>
                    <input id="cPax" type="number" placeholder="כמות אנשים" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white outline-none">
                    <button onclick="state.formData.clientName=document.getElementById('cName').value; state.formData.pax=document.getElementById('cPax').value; saveBooking(event)" class="w-full btn-amber py-3 rounded-xl">אשר הזמנה</button>
                    <button onclick="updateState({isAdding: false})" class="w-full text-slate-500 text-sm">ביטול</button>
                </div>
            `;
        }

        auth.onAuthStateChanged(user => {
            if (!user) { auth.signInAnonymously(); return; }
            db.collection('reservations').onSnapshot(snap => { updateState({ reservations: snap.docs.map(d => ({ id: d.id, ...d.data() })) }); });
            const savedRole = localStorage.getItem('club_role');
            if (savedRole) updateState({ role: savedRole, userName: localStorage.getItem('club_name'), phone: localStorage.getItem('club_phone') });
        });
    </script>
</body>
</html>